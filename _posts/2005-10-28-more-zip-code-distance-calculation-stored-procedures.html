---
layout: post
title: More Zip Code Distance Calculation... Stored Procedures
date: 2005-10-28
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
To take last night's post, <a href="http://hdevj.blogspot.com/2005/10/efficiently-calculating-zip-code.html">Efficiently Calculating Zip Code Radius With SQL</a>, one step farther I have created stored procedures to keep the logic entirely within the database.<br /><br /><span style="font-weight: bold;">Procedure Definitions</span><br /><pre>/* params = lat1, lon1, lat2, lon2, return = distance */<br />CREATE OR REPLACE FUNCTION  LatLonDistance( float8, float8, float8, float8 ) RETURNS float8<br />AS 'SELECT SQRT(POW((69.1*($2-$4)*COS($3/57.3)),2)+POW((69.1*($1-$3)),2));<br />' LANGUAGE 'sql' RETURNS NULL ON NULL INPUT;<br /><br />/* params = zip1, zip2, return = distance */<br />CREATE OR REPLACE FUNCTION ZipDistance( int4, int4 ) RETURNS float8<br />AS 'SELECT LatLonDistance( zd.lat, zd.lon,zd2.lat,zd2.lon )<br />     FROM zipdata zd, zipdata zd2<br />     WHERE zd.zipcode = $1<br />     and zd2.zipcode = $2;<br />' LANGUAGE 'sql' RETURNS NULL ON NULL INPUT;<br /></pre><br /><br /><span style="font-weight: bold;">Usage</span><br />This is just as versitile, but much cleaner than te quries last night:<br /><br /><span style="font-weight: bold;">a. </span>Getting the distance between two users:<br /><pre>SELECT u.username, u2.username, ZipDistance( u.zipcode, u2.zipcode ) AS distance<br />FROM users u, users u2<br />WHERE u.username='harlan' AND u2.username='zack';</pre><br /><span style="font-weight: bold;">b. </span>Getting all users within 10 miles of a zipcode (55431):<br /><pre>SELECT u.username<br />FROM users u<br />WHERE ZipDistance( 55431, u.zipcode ) <><br /></pre></div>
