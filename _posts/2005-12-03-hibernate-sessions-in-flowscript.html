---
layout: post
title: Hibernate Sessions In Flowscript
date: 2005-12-03
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
<span style="font-style: italic;">Note: This is only a draft, including code.</span><br /><br />I ran into a problem with the solution Cocoon + Hibernate gives for closing sessions. It wasn't a fundamental problem, simply an inflexibility that needed to be addressed. The problem was that for flowscripts (CForms + Bean binding) I wanted to be able to 1) keep a hibernate session alive between user requests and 2) still take advantage of lazy initialization in the view using the ServletFilter solution given by the tutorial.<br /><br />To achieve these goals I simply tweaked the doFilter function in the filter and created a HibernateSessionFacade:<br /><code><br />public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {<br /><br />      // create an ArrayList to add disposable hibernate sessions to<br />      ArrayList sessions = new ArrayList();<br />      request.setAttribute( "DisposeHibernateSessions", sessions );<br /><br />      // Pass the request on to cocoon<br />      chain.doFilter(request, response);<br />   <br />      //List sessions = (List)request.getAttribute( "DisposeHibernateSessions" );<br /><br />      // After cocoon has finished processing, close the<br />      // corresponding Hibernate sessions (see HibernateSessionFacade<br />      if( sessions != null &&amp; sessions.size() > 0 )<br />      {<br />          Iterator it = sessions.iterator();<br /><br />          while( it.hasNext() ) {<br />              Session hs = (Session)it.next();<br /><br />              if( hs != null &&amp; hs.isOpen() ) {<br /><br />                  System.out.println("HibernateFilter: Closing Hibernate Session");<br /><br />                  try{<br />                      hs.flush();<br />                      hs.connection().close();<br />                      hs.close();<br />                  }<br />                  catch( HibernateException e ){<br />                      System.out.println("HibernateFilter HibernateException: "+e.getMessage());<br />                  }<br />                  catch( SQLException e ){<br />                      System.out.println("HibernateFilter SQLException: "+e.getMessage());<br />                  }<br />              }<br />          }<br /><br />      }<br />  }<br /></code><br /><br /><code><br />function HibernateSessionFacade() {<br /><br />}<br /><br />HibernateSessionFacade.getSession = function( scheduleDisposal ) {<br />if( scheduleDisposal == undefined ) { scheduleDisposal = true; }<br /><br />// Get new Session from PersistenceFactory<br />var factory = cocoon.getComponent( Packages.org.osspace.cocoon.hibernate.PersistenceFactory.ROLE );<br />var hs = factory.createSession();<br />if (hs == null) {<br /> throw new Packages.org.apache.cocoon.ProcessingException( "Hibernate session is null" );<br />}<br /><br />// Release PersistenceFactory<br />cocoon.releaseComponent(factory);<br /><br />if( scheduleDisposal ) {<br />HibernateSessionFacade.scheduleDisposal( hs );<br />}<br /><br />return hs;<br />}<br /><br /><br />HibernateSessionFacade.scheduleDisposal = function( hs ) {<br />// returns an ArrayList that was set by the HibernateFilter and adds the passed<br />// session to it. it will be removed at the end of the request<br />var sessions = cocoon.request.getAttribute( "DisposeHibernateSessions" );<br /><br />if( sessions == null ) {<br />throw new Packages.org.apache.cocoon.ProcessingException("Could not schedule session for removal; the HibernateFilter did not create a list.");<br />}<br />sessions.add( hs );<br />}<br /><br /></code><br /><br />This</div>
