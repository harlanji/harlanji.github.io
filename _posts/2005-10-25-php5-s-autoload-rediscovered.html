---
layout: post
title: PHP5's __autoload() rediscovered
date: 2005-10-25
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
<p>Today I had an idea that seemed neat: a self-learning <a href="http://us3.php.net/manual/en/language.oop5.autoload.php">__autoload</a>() function. The idea was that since PHP doesn't enforce the one class per file rule, or even have namespaces for hierarchical directory naming, it is fairly common to find several classes in a single file. This can get to be confusing if one tries to be conservative with the number of files they include.<br /></p> <p>To solve this problem, I wrote a small function that will traverse a directory tree and return a hash table of className => path.<br /></p><br /><pre><br />$classes = array();<br />getClasses( ".", $classes );<br /><br />// this is an ultra-simplistic implementation. it<br />// uses a global just so it doesn't have to reload<br />// with every iteration. a better implementation<br />// may be to wrap this all into a singleton class.<br />function __autoload( $className ) {<br /> global $classes;<br /> if( isset( $classes[$className] ) &&amp; file_exists( $classes[$className] ) ) {<br />  require_once( $classes[$className] );<br />  return true;<br /> }<br /><br />}<br /><br /><br />function getClasses( $path, &$classes, $fileNamePattern = null ) {<br /> if( is_dir( $path ) ) {<br />  $d = opendir( $path );<br />  while( $fileName = readdir( $d ) ) {<br />   if( preg_match( '/^\.\.?$/', $fileName ) ) { continue; }<br />   // check to see that the filename matches the user's pattern<br />   if( $fileNamePattern &&amp; !preg_match( $fileNamePattern, $fileName ) ) { continue; }<br />  <br />   getClasses( "$path/$fileName", $classes );<br />  }<br />  closedir( $d );<br /> } elseif( file_exists( $path ) ) {<br />  // one could do this line by line if memory is an issue<br />  $data = file_get_contents( $path );<br /><br />  preg_match_all( "/(class|interface)[\n\r\s]+(\w+)/", $data, $m );<br /><br />  foreach( $m[2] as $className ) {<br />   $classes[$className] = $path;<br />  }<br /> }<br /><br />}<br /></pre><p><br />While this could be made much more versatile with file modification times used<br />for rescanning files, caching between requests and the like, I have<br />just kept it simple to illustrate the main idea and let you improve<br />upon it as you so desire.</p></div>
