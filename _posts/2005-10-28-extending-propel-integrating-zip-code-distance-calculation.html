---
layout: post
title: Extending Propel -- Integrating Zip Code Distance Calculation
date: 2005-10-28
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
For the <a href="http://hdevj.blogspot.com/2005/10/more-zip-code-distance-calculation.html">past day</a> I've been working a lot with zip code distance calculation, and now it's time to integrate my findings into my application. I've chosen to build my application around the <a href="http://propel.phpdb.org/">Propel</a> framework, so my code will be added to the application classes which Propel so graciously generates skeletons for.<br /><br />We'll start out with the Event class. We want to get all events within n miles of a particular zipcode. Since this is generalized beyond the level of Event, we will place it within the EventPeer class (for more information, read Propel's documentation).<br /><br /><pre>class EventPeer extends BaseEventPeer {<br /><br />static function GetWithinRadius( $zip, $maxDistance ) {<br /> $con = Propel::getConnection(self::DATABASE_NAME);<br /><br /> // get a list of columns that we actually care about (sort of hackish, but not really. see Select <a href="http://propel.phpdb.org/docs/user_guide/chapters/FindingObjects.html#WritingSQL">Using SQL</a> in Propel's user guide)<br /> $c = new Criteria();<br /> self::addSelectColumns( $c );<br /><br /> $sql = "SELECT ".join( ",", $c->getSelectColumns() )." FROM ".self::TABLE_NAME." WHERE ZipDistance(?, ".self::ZIPCODE.") < ?";     $stmt = $con->prepareStatement( $sql );<br /> $stmt->setInt( 1, $zip );<br /> $stmt->setInt( 2, $maxDistance );<br /><br /> $rs = $stmt->executeQuery(ResultSet::FETCHMODE_NUM);<br /><br /> return self::populateObjects($rs);<br />}<br /><br />}</pre><br /><br />Easy enough? yep. We implement UserPeer::GetWithinRadius exactly the same. Now as an exercise to show you how fun Propel can be, here is a function to get all events within n miles of a particular User:<br /><br /><pre>class User extends BaseUser {<br />function getNearByEvents( $maxDistance ) {<br /> $zip = $this->getZipCode();<br /><br /> return EventPeer::GetWithinRadius( $zip, $maxDistance );<br />}<br />}</pre><br /><br />This is ridiculously simple, isn't it? I'd like to give thanks to the inventors of stored procedures and Propel.</div>
