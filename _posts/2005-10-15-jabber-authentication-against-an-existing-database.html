---
layout: post
title: Jabber authentication against an existing database
date: 2005-10-15
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
<strong>Objective:</strong><br />Configure a jabber server which authenticates against an existing userbase and "just works" when a user tries to log to the jabber server in using their credentials.<br /><br /><strong>Projects utilized:</strong><br />JabberD 2.0.3<br />PostgreSQL 7.4.7<br /><br /><strong>Outcome:</strong><br />Success, while I could have reached the objective using my existing jabberd 1.4.3 setup, I opted instead to upgrade to jabberd2. My reasoning for this was mostly whim, 1) I couldn't find a stand-alone copy of xdb_sql because of some issues with a server being hacked, and the author not re-verifying the code. I could have tried stripping it from the 1.4.4 distribution, but I wasn't sure if it was complete and I couldn't find much in the way of documentation about it. 2) I have no prior experience with jabberd2 and wanted it.<br /><br />jabberd2 includes database backend support out of the box, there is the advantage that all data is now stored in the database where they were in xdb_file before. This was an unexpect, but welcome surprise to me; I had planned at exploring options for relational database storage of the roster and other data after I finished this project.<br /><br /><strong>Steps:</strong><br />First of all, I built the jabberd2 port on freebsd using the WITH_POSTGRESQL option. Next I followed the instructions <a href="http://jabberd.jabberstudio.org/2/docs/section03.html">here</a> to get the server setup and authenticating against a brand new database. Once I was able to observe the data the server created, I was able to determine that only the authreg table needed to be in my current app's database. So I went to town looking for how to make my custom queries like xdb_sql would allow in jabber1.4, but there was no documentation of the sort for jabberd2. Finally after some googling I found <a href="http://mail.jabber.org/pipermail/jabberd/2005-February/002475.html">this thread</a> which explained that the sm module is basically set in stone, but the c2s module is as flexible as xdb_sql. After some tinkering, I found that this functionality was indeed possible, though undocumented. In the end, I changed c2s to use my existing database with these settings:<br /><pre><br />&lt;pgsql&gt;<br />    &lt;!-- Database server host and port --&gt;<br />    &lt;host&gt;localhost&lt;/host&gt;<br />    &lt;port&gt;5432&lt;/port&gt;<br /><br />    &lt;!-- Database name --&gt;<br />    &lt;dbname&gt;mint2&lt;/dbname&gt;<br /><br />    &lt;!-- Database username and password --&gt;<br />    &lt;user&gt;xxxxxx&lt;/user&gt;<br />    &lt;pass&gt;xxxxxx&lt;/pass&gt;<br /><br />    &lt;table&gt;users&lt;/table&gt;<br /><br />    &lt;sql&gt;<br />      &lt;!-- use 32 as a flag for disabled jabber account --&gt;<br />      &lt;select&gt;SELECT "password" FROM "users" WHERE "username" = '%s' AND "realm" = '%s' AND (status & 32) = 0&lt;/select&gt;<br />      &lt;delete&gt;UPDATE "users" SET status = status | 32  WHERE "username" = '%s' AND "realm" = '%s'&lt;/delete&gt;<br />    &lt;/sql&gt;<br />  &lt;/pgsql&gt;<br /></pre><br /><br />I was also required to enable &lt;auto-create/&gt; in the sm module for the active table. An alternative to this would be to create an entry in my registration script OR to setup another handler for the active data. The latter would be the best option IMO, but for now auto-create will more than suffice.</div>
